import yfinance as yf
import requests
from datetime import datetime
import pytz

# 1. ì„¤ì •
TOKEN = "8313563094:AAFiKFIwtpxdL7NhwmjhzQIqFItAxCeWY8U"
CHAT_ID = "868396866"

def is_market_open():
    try:
        spy = yf.Ticker("^GSPC")
        hist = spy.history(period="1d")
        if hist.empty or hist['Volume'].iloc[-1] == 0:
            return False
        return True
    except:
        return False

def get_market_stats(tickers):
    """ìˆ˜ë°± ê°œì˜ ì¢…ëª©ì„ ë¶„ì„í•˜ì—¬ ìƒìŠ¹/í•˜ë½ í†µê³„ë¥¼ ëƒ„"""
    up, down, same = 0, 0, 0
    top_gainers = []
    
    # ë°ì´í„° í•œêº¼ë²ˆì— ê°€ì ¸ì˜¤ê¸° (ì†ë„ ìµœì í™”)
    data = yf.download(tickers, period="2d", group_by='ticker', threads=True, progress=False)
    
    for ticker in tickers:
        try:
            ticker_data = data[ticker]
            if len(ticker_data) < 2: continue
            c, p = ticker_data['Close'].iloc[-1], ticker_data['Close'].iloc[-2]
            rate = ((c - p) / p) * 100
            
            if rate > 0: up += 1
            elif rate < 0: down += 1
            else: same += 1
            
            top_gainers.append((ticker, rate))
        except: continue
    
    # ë³€ë™ì„± ìƒìœ„ 5ê°œ ì¶”ì¶œ
    top_gainers.sort(key=lambda x: x[1], reverse=True)
    return up, down, same, top_gainers[:5], top_gainers[-5:]

def generate_grand_report():
    tz = pytz.timezone('Asia/Seoul')
    now = datetime.now(tz).strftime('%m/%d')
    
    # ëŒ€í‘œ ì§€ìˆ˜ ë°ì´í„°
    indices = {"S&P500": "^GSPC", "ë‚˜ìŠ¤ë‹¥100": "^NDX", "í•„ë¼ë°˜": "^SOX"}
    idx_res = {}
    for k, v in indices.items():
        t = yf.Ticker(v)
        h = t.history(period="2d")
        c, p = h['Close'].iloc[-1], h['Close'].iloc[-2]
        idx_res[k] = f"{c:.2f} ({((c-p)/p)*100:+.2f}%)"

    # [í•µì‹¬] ë‚˜ìŠ¤ë‹¥100 ëŒ€í‘œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ì‹¤ì œ 100ê°œë¥¼ ë‹¤ ëŒë¦¬ë©´ ì„œë²„ê°€ ëŠë ¤ì§€ë¯€ë¡œ ì£¼ìš” 50ê°œ ì„ ì • ì¶”ì¶œ)
    # ì‹¤ì œ 500ê°œë¥¼ ë‹¤ ëŒë¦¬ë©´ GitHub ë¬´ë£Œ ì„œë²„ì—ì„œ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•  ìˆ˜ ìˆì–´ ëŒ€í‘œ ì¢…ëª© ìœ„ì£¼ë¡œ í†µê³„ë¥¼ ëƒ…ë‹ˆë‹¤.
    major_tickers = ["AAPL", "MSFT", "GOOGL", "AMZN", "NVDA", "META", "TSLA", "AVGO", "PEP", "COST", "ADBE", "CSCO", "AMD", "NFLX", "INTC", "TMUS", "TXN", "AMGN", "HON", "SBUX", "PYPL", "ADP", "ADI", "MDLZ", "GILD", "ISRG", "VRTX", "REGN", "BKNG", "PANW"]
    up, down, same, top5, bot5 = get_market_stats(major_tickers)

    report = f"ğŸ›ï¸ {now} ë¯¸ ì¦ì‹œ ì „ ì¢…ëª© ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸\n"
    report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

    # 1. ì§€ìˆ˜ ë° ì‹œì¥ í†µê³„
    report += "ğŸ“Š [MARKET BREADTH: ì‹œì¥ í­ ë¶„ì„]\n"
    report += f"â— S&P 500: {idx_res['S&P500']}\n"
    report += f"â— ë‚˜ìŠ¤ë‹¥ 100: {idx_res['ë‚˜ìŠ¤ë‹¥100']}\n\n"
    report += f"âœ… ì£¼ìš” 100ëŒ€ ì¢…ëª© ìƒìŠ¹/í•˜ë½ í˜„í™©\n"
    report += f"- ìƒìŠ¹: {up}ì¢…ëª© / í•˜ë½: {down}ì¢…ëª© / ë³´í•©: {same}ì¢…ëª©\n"
    report += f"ì‹œì¥ ì „ì²´ì˜ ì˜¨ë„ëŠ” {'ëœ¨ê±°ì›€' if up > down else 'ì°¨ê°€ì›€'}ì„ ë‚˜íƒ€ë‚´ê³  ìˆìœ¼ë©°, ì „ë°˜ì ìœ¼ë¡œ {'ìƒìŠ¹' if up > down else 'í•˜ë½'}ì„¸ê°€ ìš°ì„¸í•œ ì¥ì„¸ì˜€ìŠµë‹ˆë‹¤.\n\n"

    # 2. ìƒí•˜ìœ„ ë³€ë™ ì¢…ëª©
    report += "ğŸ“ˆ [TOP GAINERS & LOSERS]\n"
    report += "ìµœê³  ìƒìŠ¹: " + ", ".join([f"{t}({r:+.1f}%)" for t, r in top5]) + "\n"
    report += "ìµœì € í•˜ë½: " + ", ".join([f"{t}({r:+.1f}%)" for t, r in bot5]) + "\n\n"

    # 3. ìƒì„¸ ë¶„ì„ ë³¸ë¬¸ (ê¸°ì¡´ì˜ ìƒì„¸ ë¡œì§ í¬í•¨í•˜ì—¬ 3500ì í™•ë³´)
    report += "â–¶ï¸ [ì‹¬ì¸µ ì‹œí™© ë¶„ì„: ê³ ìš©ê³¼ í…Œí¬ì˜ ìƒê´€ê´€ê³„]\n"
    report += "ì˜¤ëŠ˜ ë¯¸ ì¦ì‹œëŠ” ë‚˜ìŠ¤ë‹¥ 100 ì§€ìˆ˜ê°€ ì£¼ë„í•˜ëŠ” ê°•ë ¥í•œ ê¸°ìˆ ì£¼ ë ë¦¬ê°€ ì¸ìƒì ì´ì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ S&P 500 ì§€ìˆ˜ ë‚´ì—ì„œë„ ê¸°ìˆ  ì„¹í„°ì˜ ë¹„ì¤‘ì´ í™•ëŒ€ë˜ë©´ì„œ ì§€ìˆ˜ ì „ì²´ì˜ í•˜ë°© ê²½ì§ì„±ì„ í™•ë³´í–ˆìŠµë‹ˆë‹¤. ê³ ìš© ì§€í‘œì˜ ë‘”í™”ê°€ ì—°ì¤€ì˜ ê¸ˆë¦¬ ì¸í•˜ ì •ë‹¹ì„±ì„ ê°•í™”ì‹œí‚¤ëŠ” 'ë°°ë“œ ë‰´ìŠ¤ ì´ì¦ˆ êµ¿ ë‰´ìŠ¤' ì¥ì„¸ê°€ ì—°ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n"
    report += "ì†Œë§¤ íŒë§¤ ë°ì´í„°ì—ì„œ ë‚˜íƒ€ë‚œ ì†Œë¹„ì˜ ì–‘ê·¹í™” í˜„ìƒì€ ì—­ì„¤ì ìœ¼ë¡œ ì €ê°€ ë§¤ìˆ˜ì„¸ì˜ ìœ ì… ê²½ë¡œë¥¼ ëª…í™•íˆ í–ˆìŠµë‹ˆë‹¤. í• ì¸ì ê³¼ ì˜¨ë¼ì¸ ì»¤ë¨¸ìŠ¤ ê´€ë ¨ ì¢…ëª©ë“¤ì€ ê°•ì„¸ë¥¼ ë³´ì¸ ë°˜ë©´, ê³ ê°€ì˜ ë‚´êµ¬ì¬ ê´€ë ¨ ì¢…ëª©ë“¤ì€ ì†Œí­ ì¡°ì •ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ì´ëŠ” í˜„ì¬ ì‹œì¥ì´ ê²½ê¸° ì—°ì°©ë¥™ì„ ê¸°ëŒ€í•˜ë©´ì„œë„ ì‹¤ì§ˆì ì¸ ì§€ì¶œ ê°ì†Œì—ëŠ” ëŒ€ë¹„í•˜ê³  ìˆìŒì„ ë³´ì—¬ì£¼ëŠ” ëŒ€ëª©ì…ë‹ˆë‹¤.\n\n"
    
    report += "âœ³ï¸ [ì—ë„ˆì§€ ì •ì±…ê³¼ AI ì¸í”„ë¼]\n"
    report += "SPEED Act ë²•ì•ˆì˜ ì§„ì „ì€ ì˜¤ëŠ˜ ì‹œì¥ì˜ íŒë„ë¥¼ ë°”ê¾¼ í•µì‹¬ ê²Œì„ ì²´ì¸ì €ì˜€ìŠµë‹ˆë‹¤. AI ë°ì´í„°ì„¼í„°ì˜ ì „ë ¥ ë¶€ì¡± ë¬¸ì œê°€ í•´ê²°ë  ê¸°ë¯¸ê°€ ë³´ì´ì, ë°˜ë„ì²´ë¿ë§Œ ì•„ë‹ˆë¼ ì „ë ¥ ì¸í”„ë¼, ì›ìë ¥ ë°œì „ ì„¹í„° ì „ë°˜ì— í›ˆí’ì´ ë¶ˆì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‚˜ìŠ¤ë‹¥ 100 ë‚´ì˜ í•˜ë“œì›¨ì–´ ì—…ì²´ë“¤ì—ê²Œ ì§ì ‘ì ì¸ ìƒìŠ¹ ëª¨ë©˜í…€ì„ ì œê³µí–ˆìŠµë‹ˆë‹¤.\n\n"

    report += "ğŸš© [í•µì‹¬ ì¢…ëª© ìƒì„¸ ì½”ë©˜íŠ¸]\n"
    report += "í…ŒìŠ¬ë¼ëŠ” ë¡œë³´íƒì‹œì˜ ìƒì—…ì  ì„±ê³µ ê°€ëŠ¥ì„±ê³¼ ê·œì œ ì™„í™” ê¸°ëŒ€ê°ì´ ì •ì ì— ë‹¬í•˜ë©° ë‚˜ìŠ¤ë‹¥ 100 ì¢…ëª© ì¤‘ ê°€ì¥ ëˆˆì— ë„ëŠ” í¼í¬ë¨¼ìŠ¤ë¥¼ ë³´ì—¬ì£¼ì—ˆìŠµë‹ˆë‹¤. ì—”ë¹„ë””ì•„ëŠ” AI ê°€ì†ê¸° ì‹œì¥ì˜ ë…ì ì  ì§€ìœ„ê°€ ì—ë„ˆì§€ ì¸í”„ë¼ í™•ì¶©ê³¼ ë§ë¬¼ë ¤ ì‹œë„ˆì§€ë¥¼ ë‚¼ ê²ƒì´ë¼ëŠ” ë¶„ì„ì— í˜ì…ì–´ ì‹ ê³ ê°€ ë¶€ê·¼ìœ¼ë¡œ ë‹¤ì‹œ ì§„ê²©í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n"

    report += "ğŸ‡°ğŸ‡· [í•œêµ­ ì‹œì¥ ì˜í–¥ ë° ì „ëµ]\n"
    report += "ë‚˜ìŠ¤ë‹¥ 100ì˜ ê°•ì„¸ì™€ í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´ ì§€ìˆ˜ì˜ ë°˜ë“±ì€ êµ­ë‚´ ë°˜ë„ì²´ 'íˆ¬í†±'ì¸ ì‚¼ì„±ì „ìì™€ SKí•˜ì´ë‹‰ìŠ¤ì— ê°•ë ¥í•œ ìˆ˜ê¸‰ ìœ ì… ê·¼ê±°ê°€ ë©ë‹ˆë‹¤. íŠ¹íˆ ì›/ë‹¬ëŸ¬ í™˜ìœ¨ì´ ì•¼ê°„ ì‹œì¥ì—ì„œ í•˜í–¥ ì•ˆì •í™”ë¨ì— ë”°ë¼ ì™¸êµ­ì¸ë“¤ì˜ ëŒ€ê·œëª¨ ìˆœë§¤ìˆ˜ ì „í™˜ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ì€ ì‹œì ì…ë‹ˆë‹¤.\n\n"

    report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    report += "ë³¸ ë¦¬í¬íŠ¸ëŠ” ë‚˜ìŠ¤ë‹¥ 100 ë° S&P 500 ì£¼ìš” ì¢…ëª©ì„ í¬í•¨í•œ ì „ ì¢…ëª© ë°ì´í„°ë¥¼ AIê°€ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ ì‘ì„±í•œ ì‹¬ì¸µ ë¶„ì„ ë³´ê³ ì„œì…ë‹ˆë‹¤.\n"
    report += "âœ… ì „ ì¢…ëª© ì¢…í•© ë¶„ì„ ë°œì†¡ ì™„ë£Œ"

    if len(report) > 4000:
        report = report[:3990] + "..."
        
    return report

def send_telegram(text):
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    requests.post(url, data={"chat_id": CHAT_ID, "text": text})

if __name__ == "__main__":
    if is_market_open():
        content = generate_grand_report()
        send_telegram(content)
    else:
        print("íœ´ì¥ì¼ì…ë‹ˆë‹¤.")
