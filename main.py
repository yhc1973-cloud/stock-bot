import yfinance as yf
import requests
from datetime import datetime
import pytz

# 1. ì„¤ì • (ê¸°ì¡´ ì •ë³´ ìœ ì§€)
TOKEN = "8313563094:AAFiKFIwtpxdL7NhwmjhzQIqFItAxCeWY8U"
CHAT_ID = "868396866"

def is_market_open():
    """ë¯¸êµ­ ì§€ìˆ˜(S&P 500) ë°ì´í„°ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì¥ì´ ì—´ë ¸ì—ˆëŠ”ì§€ ì²´í¬"""
    try:
        # S&P 500 ì§€ìˆ˜(^GSPC)ì˜ ìµœê·¼ 1ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        spy = yf.Ticker("^GSPC")
        hist = spy.history(period="1d")
        
        # ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜, ê±°ë˜ëŸ‰ì´ 0ì´ë©´ íœ´ì¥ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.
        if hist.empty or hist['Volume'].iloc[-1] == 0:
            return False
        return True
    except:
        # ì—ëŸ¬ ë°œìƒ ì‹œ ì•ˆì „ì„ ìœ„í•´ íœ´ì¥ìœ¼ë¡œ ê°„ì£¼í•˜ê±°ë‚˜ Trueë¡œ ì„¤ì •í•  ìˆ˜ ìˆìœ¼ë‚˜, 
        # ì—¬ê¸°ì„œëŠ” ë°ì´í„° í™•ì¸ì´ ì•ˆ ë˜ë©´ ì•ˆ ë³´ë‚´ëŠ” ê²ƒìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        return False

def get_data(symbol):
    try:
        t = yf.Ticker(symbol)
        h = t.history(period="2d")
        if not h.empty:
            c, p = h['Close'].iloc[-1], h['Close'].iloc[-2]
            r = ((c - p) / p) * 100
            return f"{c:.2f} ({r:+.2f}%)"
    except: return "N/A"
    return "N/A"

def generate_report():
    tz = pytz.timezone('Asia/Seoul')
    now = datetime.now(tz).strftime('%m/%d')
    
    # ë°ì´í„° ìˆ˜ì§‘ ëŒ€ìƒ
    targets = {
        "ë‹¤ìš°": "^DJI", "ë‚˜ìŠ¤ë‹¥": "^IXIC", "S&P500": "^GSPC", "í•„ë¼ë°˜": "^SOX",
        "ì—”ë¹„ë””ì•„": "NVDA", "í…ŒìŠ¬ë¼": "TSLA", "ì• í”Œ": "AAPL", "ë©”íƒ€": "META"
    }
    res = {k: get_data(v) for k, v in targets.items()}

    # ë¦¬í¬íŠ¸ ë‚´ìš© êµ¬ì„±
    report = f"ğŸ’ {now} ë¯¸ ì¦ì‹œ ì‹¬ì¸µ ë¦¬í¬íŠ¸\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
    report += f"ğŸ“Š [ì§€ìˆ˜ ì •ë³´]\në‚˜ìŠ¤ë‹¥: {res['ë‚˜ìŠ¤ë‹¥']} / S&P500: {res['S&P500']}\n\n"
    
    report += "â–¶ï¸ [ì‹œí™© ì´í‰ ë° ìƒì„¸ ë¶„ì„]\n"
    report += "ê¸ˆì¼ ë¯¸ ì¦ì‹œëŠ” ê³ ìš© ì§€í‘œì˜ ì—‡ê°ˆë¦° ì‹ í˜¸ì™€ ì—°ì¤€ ìœ„ì›ë“¤ì˜ ë°œì–¸ì„ ì†Œí™”í•˜ë©° ë³€ë™ì„±ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. íŠ¹íˆ ì¥ê¸° ì‹¤ì—…ìì˜ ì¦ê°€ëŠ” ê²½ê¸° ì¹¨ì²´ ìš°ë ¤ë¥¼ ìê·¹í–ˆìœ¼ë‚˜, AI ì¸í”„ë¼ ê´€ë ¨ SPEED Act ë²•ì•ˆì˜ ì§„ì „ ì†Œì‹ì€ ë¹…í…Œí¬ ì„¹í„°ì— ê°•ë ¥í•œ ë§¤ìˆ˜ì„¸ë¥¼ ìœ ì…ì‹œì¼°ìŠµë‹ˆë‹¤.\n\n"
    report += "í…ŒìŠ¬ë¼ëŠ” ë¡œë³´íƒì‹œ ë¹„ì „ê³¼ ì˜µì…˜ ìˆ˜ê¸‰ì˜ ê²°í•©ìœ¼ë¡œ ì‚¬ìƒ ìµœê³ ì¹˜ë¥¼ ê²½ì‹ í•˜ë©° ì‹œì¥ì˜ ì˜ì›… ì—­í• ì„ í–ˆìŠµë‹ˆë‹¤. ì—”ë¹„ë””ì•„ ë˜í•œ ê·œì œ ìš°ë ¤ë¥¼ ëš«ê³  AI ì¸í”„ë¼ì˜ í•µì‹¬ ì§€ìœ„ë¥¼ ì¬í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì „ì²´ì ìœ¼ë¡œ 'ì‹¤ì 'ê³¼ 'ì •ì±…'ì´ ì‹œì¥ì„ ì´ë„ëŠ” ì¥ì„¸ì˜€ìŠµë‹ˆë‹¤.\n\n"
    
    report += "ğŸš© [ì„¹í„°ë³„ ìƒì„¸ ì½”ë©˜íŠ¸]\n"
    report += f"- ë°˜ë„ì²´: ì—”ë¹„ë””ì•„({res['ì—”ë¹„ë””ì•„']})ëŠ” AI ìˆ˜ìš”ì˜ ê²¬ì¡°í•¨ì„ ì¦ëª…í–ˆìŠµë‹ˆë‹¤.\n"
    report += f"- ìë™ì°¨: í…ŒìŠ¬ë¼({res['í…ŒìŠ¬ë¼']})ëŠ” ì••ë„ì ì¸ ìˆ˜ê¸‰ìœ¼ë¡œ ì§€ìˆ˜ë¥¼ ê²¬ì¸í–ˆìŠµë‹ˆë‹¤.\n"
    report += f"- í”Œë«í¼: ë©”íƒ€({res['ë©”íƒ€']})ëŠ” AI ê´‘ê³  ìˆ˜ìµí™” ê¸°ëŒ€ê°ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.\n\n"
    
    report += "ğŸŒ [êµ­ë‚´ ì¦ì‹œ ëŒ€ì‘]\n"
    report += "ë¯¸ ì¦ì‹œì˜ ì¥ í›„ë°˜ ë°˜ë“±ê³¼ ì•¼ê°„ ì„ ë¬¼ì˜ ê¸ì •ì  íë¦„ì„ ê³ ë ¤í•  ë•Œ, í•œêµ­ ì¦ì‹œ ì—­ì‹œ ë°˜ë“± ì¶œë°œì´ ì˜ˆìƒë©ë‹ˆë‹¤. ë°˜ë„ì²´ ëŒ€í˜•ì£¼ì˜ ìˆ˜ê¸‰ ê°œì„  ì—¬ë¶€ë¥¼ ì£¼ëª©í•˜ì‹­ì‹œì˜¤.\n\n"
    report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… ë¶„ì„ ì™„ë£Œ"

    if len(report) > 3800:
        report = report[:3797] + "..."
        
    return report

def send_telegram(text):
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    res = requests.post(url, data={"chat_id": CHAT_ID, "text": text})
    if res.status_code == 200:
        print("âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ ì„±ê³µ!")
    else:
        print(f"âŒ ì „ì†¡ ì‹¤íŒ¨! ì‚¬ìœ : {res.text}")

if __name__ == "__main__":
    # ğŸ”¥ [ìˆ˜ì •ëœ í•µì‹¬ ë¡œì§]
    # ë¯¸êµ­ ì‹œì¥ì´ ì—´ë ¸ì—ˆëŠ”ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
    if is_market_open():
        content = generate_report()
        send_telegram(content)
    else:
        # íœ´ì¥ì¼ì´ë©´ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  í…”ë ˆê·¸ë¨ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        print("ğŸ“¢ ì˜¤ëŠ˜ì€ ë¯¸êµ­ ì¦ì‹œ íœ´ì¥ì¼(ë˜ëŠ” ë°ì´í„° ì—†ìŒ)ì´ë¯€ë¡œ ë¦¬í¬íŠ¸ë¥¼ ë°œì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
