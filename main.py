import yfinance as yf
import requests
from datetime import datetime
import pytz

# 1. í…”ë ˆê·¸ëž¨ ì„¤ì •
TOKEN = "8313563094:AAFiKFIwtpxdL7NhwmjhzQIqFItAxCeWY8U"
CHAT_ID = "868396866"

def get_data(symbol):
    try:
        t = yf.Ticker(symbol)
        h = t.history(period="5d")
        if not h.empty:
            c, p = h['Close'].iloc[-1], h['Close'].iloc[-2]
            r = ((c - p) / p) * 100
            return f"{c:.2f} ({r:+.2f}%)"
    except: return "N/A"
    return "N/A"

def generate_safe_report():
    tz = pytz.timezone('Asia/Seoul')
    now = datetime.now(tz).strftime('%m/%d')
    
    # ë°ì´í„° ìˆ˜ì§‘ (ì§€ìˆ˜ ë° ì£¼ìš” ì¢…ëª©)
    targets = {
        "ë‹¤ìš°": "^DJI", "ë‚˜ìŠ¤ë‹¥": "^IXIC", "S&P500": "^GSPC", "í•„ë¼ë°˜": "^SOX", "ëŸ¬ì…€2000": "^RUT",
        "ì—”ë¹„ë””ì•„": "NVDA", "í…ŒìŠ¬ë¼": "TSLA", "ì• í”Œ": "AAPL", "MS": "MSFT", "ë©”íƒ€": "META"
    }
    res = {k: get_data(v) for k, v in targets.items()}

    # ë¦¬í¬íŠ¸ ë¹Œë“œ ì‹œìž‘
    report = f"ðŸ’Ž {now} ë¯¸ ì¦ì‹œ ì¸í…”ë¦¬ì „ìŠ¤ ë¦¬í¬íŠ¸\n"
    report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

    # [1] ì§€ìˆ˜ í˜„í™©
    report += "ðŸ“Š [ì§€ìˆ˜ í˜„í™©]\n"
    for k, v in res.items():
        if k in ["ë‹¤ìš°", "ë‚˜ìŠ¤ë‹¥", "S&P500", "í•„ë¼ë°˜", "ëŸ¬ì…€2000"]:
            report += f"â€¢ {k}: {v}\n"
    report += "\n"

    # [2] ì‹œí™© ì´í‰ ë° ë³€í™”ìš”ì¸ (ìƒì„¸ ë²„ì „)
    report += "â–¶ï¸ [ì‹œí™© ì´í‰ ë° ë³€í™”ìš”ì¸]\n"
    report += "ê¸ˆì¼ ë¯¸ ì¦ì‹œëŠ” ê³ ìš© ì§€í‘œì˜ ë‘”í™”ì™€ ì†Œë§¤ íŒë§¤ì˜ ì§ˆì  ì €í•˜ ìš°ë ¤ë¥¼ ë™ì‹œì— ì†Œí™”í•˜ë©° ë³€ë™ì„± ìž¥ì„¸ë¥¼ ë‚˜íƒ€ëƒˆìŠµë‹ˆë‹¤. "
    report += "ê³ ìš© ì‹œìž¥ì€ í‘œë©´ì ìœ¼ë¡œëŠ” ê²¬ì¡°í•´ ë³´ì´ë‚˜ ì„¸ë¶€ì ìœ¼ë¡œëŠ” ìž¥ê¸° ì‹¤ì—…ìžê°€ ê²½ê¸° ì¹¨ì²´ê¸° ìˆ˜ì¤€ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” ë“± ë¶ˆì•ˆ ìš”ì†Œê°€ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤. "
    report += "í•˜ì§€ë§Œ ìž¥ ë§ˆê° ì „ AI ì¸í”„ë¼ ê·œì œ ì™„í™” ë²•ì•ˆ(SPEED Act)ì˜ ì§„ì „ ì†Œì‹ì´ ì „í•´ì§€ë©° ë¹…í…Œí¬ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ìˆ˜ê¸‰ì´ ê¸‰ê²©ížˆ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n"

    # [3] íŠ¹ì§• ì„¹í„° ë° ì¢…ëª© ë¶„ì„
    report += "ðŸš© [íŠ¹ì§• ì„¹í„° ë° ì¢…ëª© ë¶„ì„]\n"
    report += f"â–  ë°˜ë„ì²´: ì—”ë¹„ë””ì•„({res['ì—”ë¹„ë””ì•„']})ëŠ” AI ìˆ˜ìš” ì§€ì†ì„±ì— ëŒ€í•œ ì‹ ë¢° ì†ì— SPEED Act ë²•ì•ˆ í˜¸ìž¬ë¥¼ ìž…ìœ¼ë©° ë°˜ë“±í–ˆìŠµë‹ˆë‹¤. "
    report += "ë§ˆì´í¬ë¡ ì€ ì‹¤ì  ë°œí‘œ ì „ ë§¤ë¬¼ ì†Œí™” ê³¼ì •ì„ ê±°ì³¤ìœ¼ë‚˜ ë©”ëª¨ë¦¬ ì—…í™©ì— ëŒ€í•œ ê¸ì •ì  ì „ë§ì€ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n"
    report += f"â–  ìžë™ì°¨: í…ŒìŠ¬ë¼({res['í…ŒìŠ¬ë¼']})ëŠ” ë¡œë³´íƒì‹œ ê¸°ëŒ€ê°ê³¼ ì˜µì…˜ ìˆ˜ê¸‰ì˜ íž˜ìœ¼ë¡œ ì‚¬ìƒ ìµœê³ ì¹˜ë¥¼ ê²½ì‹ í•˜ë©° ì§€ìˆ˜ë¥¼ ê²¬ì¸í–ˆìŠµë‹ˆë‹¤.\n"
    report += f"â–  í”Œëž«í¼: ë©”íƒ€({res['ë©”íƒ€']})ì™€ ì• í”Œ({res['ì• í”Œ']})ì€ ê°œë³„ í˜¸ìž¬ì™€ ë°˜ë°œ ë§¤ìˆ˜ì„¸ê°€ ìœ ìž…ë˜ë©° ê²¬ì¡°í•œ íë¦„ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.\n\n"

    # [4] ê±°ì‹œ ê²½ì œ (FICC) ë° í•œêµ­ ì¦ì‹œ ì˜í–¥
    report += "ðŸŒ [FICC ë° êµ­ë‚´ ì¦ì‹œ ì „ë§]\n"
    report += "êµ­ì œìœ ê°€ëŠ” ìš°í¬ë¼ì´ë‚˜ ì¢…ì „ ê¸°ëŒ€ê°ì— í•˜í–¥ ì•ˆì •í™”ë˜ì—ˆìœ¼ë©°, êµ­ì±„ ê¸ˆë¦¬ëŠ” ê³ ìš© ë‘”í™” ì§€í‘œë¥¼ ë°˜ì˜í•˜ë©° í•˜ë½ ì „í™˜í–ˆìŠµë‹ˆë‹¤. "
    report += "ë‹¬ëŸ¬í™” ì•½ì„¸ì™€ ì•¼ê°„ ì„ ë¬¼ì˜ ìƒìŠ¹(+0.59%)ì„ ê³ ë ¤í•  ë•Œ, êµ­ë‚´ ì¦ì‹œëŠ” ë°˜ë„ì²´ ëŒ€í˜•ì£¼ ì¤‘ì‹¬ì˜ ë°˜ë“± ì‹œë„ê°€ ì˜ˆìƒë©ë‹ˆë‹¤. "
    report += "ë‹¤ë§Œ í™˜ìœ¨ ë³€ë™ì„±ê³¼ ë§ˆì´í¬ë¡  ì‹¤ì  ê²°ê³¼ì— ë”°ë¥¸ ìˆ˜ê¸‰ ë³€í™”ì— ìœ ì˜í•  í•„ìš”ê°€ ìžˆìŠµë‹ˆë‹¤.\n\n"

    report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    report += "âœ… AI ì—ì´ì „íŠ¸ ìƒì„¸ ë¶„ì„ ë°œì†¡ ì™„ë£Œ\n"
    
    # âš ï¸ 4,000ìž ë¦¬ë°‹(ì œí•œ) ìž¥ì¹˜
    # 4000ìžê°€ ë„˜ìœ¼ë©´ ê·¸ ë’¤ë¥¼ ìžë¥´ê³  "..."ë¥¼ ë¶™ìž…ë‹ˆë‹¤.
    if len(report) > 4000:
        report = report[:3997] + "..."
        
    return report

def send_telegram(text):
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    requests.post(url, data={"chat_id": CHAT_ID, "text": text})

if __name__ == "__main__":
    content = generate_safe_report()
